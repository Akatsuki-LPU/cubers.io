{% extends "common/base.html" %}

{% block head %}
{{ super() }}
{% endblock %}

{% block content %}
<div class="container-fluid cubers-container white-container" style="margin-top: 15px;">
    {% if show_admin %}
    <div id="loading-spinner" class="loading hidden_icon"></div>
    {% endif %}
    <div class="row">
        <div class="col-2 col-md-2 col-lg-2">
            <div class="results-links-area">
                <div class="links-wrapper text-center">
                {% for event_name in event_names %}
                {% if event_results[event_name] %}
                    <div class="event-link">
                        <a href="#{{event_name}}">
                            <img class="event-image" src="/static/images/cube-{{ event_ids[event_name] }}.png">
                        </a>
                    </div>
                {% endif %}
                {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-10 col-md-10 col-lg-10">
            <div class="event-results-container">
                {% for event_name in event_names %}
                {% if event_results[event_name] %}
                    {% if event_formats[event_name] in ('Bo3', 'Bo1') %}
                        {% set avg_class = '' %}
                        {% set single_class = 'font-weight-bold' %}
                    {% else %}
                        {% set avg_class = 'font-weight-bold' %}
                        {% set single_class = '' %}
                    {% endif %}
                    <div class="event-results-area">
                        <div id="{{event_name}}" class="event-results-header">
                            <img class="event-image" src="/static/images/cube-{{ event_ids[event_name] }}.png">
                            <h3 class="event-name">
                                <a href="{{ url_for('event_results', event_name=event_name|replace('/','%2F')) }}">
                                    {{ event_name }}
                                </a>
                            </h3>
                        </div>
                        <table class="table table-sm table-striped table-cubersio">
                            <thead class="thead-dark">
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col" class="d-none d-md-table-cell"></th>
                                    <th scope="col">User</th>
                                    <th scope="col">Average</th>
                                    <th scope="col">Best</th>
                                    <th scope="col" colspan="5" class="d-none d-md-table-cell">Solves</th>
                                    {% if show_admin %}
                                    <th scope="col">Action</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in event_results[event_name] %}
                                {% if current_user.is_authenticated and current_user.username == result.User.username %}
                                    {% set its_me = 'hey-its-me' %}
                                {% else %}
                                    {% set its_me = '' %}
                                {% endif %}
                                <tr class="{{ its_me }}">
                                    <td scope="row">{{ loop.index }}</td>
                                    <td scope="col" class="d-none d-md-table-cell">
                                        {% if result.comment|trim() %}
                                        {% set the_comment = result.comment if result.comment|length < 500 else result.comment[:500] + "..." %}
                                        <span class="far fa-comment spacer" data-toggle="tooltip" data-placement="bottom" title="{{the_comment}}"></span>
                                        {% endif %}
                                    </td>
                                    <td scope="col">
                                        <a href="{{ url_for('profile', username=result.User.username) }}">/u/{{ result.User.username }}</a>
                                    </td>
                                    {% if event_name == "FMC" %}
                                        <td scope="col" class="font-weight-bold">{{ result.average | format_fmc_result }}</td>
                                        <td scope="col">{{ result.single | format_fmc_result }}</td>
                                        {% for solve in result.solves_helper %}
                                        <td scope="col" class="d-none d-md-table-cell">{{ solve }}</td>
                                        {% endfor %}
                                    {% else %}
                                        <td scope="col" class="{{ avg_class }}">{{ result.average | friendly_time }}</td>
                                        <td scope="col" class="{{ single_class }}">{{ result.single | friendly_time }}</td>
                                        {% for solve in result.solves_helper %}
                                        <td scope="col" class="d-none d-md-table-cell">{{ solve }}</td>
                                        {% endfor %}
                                    {% endif %}
                                    {% if show_admin %}
                                        {% if result.is_blacklisted %}
                                            <td scope="col">
                                                <button class="btn btn-success btn-xs btn-unblacklist" data-result-id="{{result.id}}" data-result-event="{{event_name}}" data-result-username="{{result.User.username}}">unblacklist</button>
                                            </th>
                                        {% else %}
                                            <td scope="col">
                                                <button class="btn btn-danger btn-xs btn-blacklist" data-result-id="{{result.id}}" data-result-event="{{event_name}}" data-result-username="{{result.User.username}}">blacklist</button>
                                            </th>
                                        {% endif %}
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_script %}
<script>
    $(function () {
        if (!Boolean(new MobileDetect(window.navigator.userAgent).mobile())) {
            $('[data-toggle="tooltip"]').tooltip();
        }

        var perform_admin_action = function(action, className, url, $event_btn) {
            var username   = $event_btn.data("result-username");
            var result_id  = $event_btn.data("result-id");
            var event_name = $event_btn.data("result-event");

            var confirm_msg = action + " this " + event_name + " result for " + username + "?";
            confirm_msg += "<br><br>This will cause a site-wide recalculation of rankings for this event."

            bootbox.confirm({
                message: confirm_msg,
                buttons: {
                    confirm: {
                        label: action,
                        className: className
                    },
                    cancel: {
                        label: 'Cancel',
                    }
                },
                callback: function (confirmed) {
                    if (confirmed) {
                        $('#loading-spinner').removeClass('hidden_icon');
                        $.get(url + result_id, function(){
                            location.reload();
                        })
                        .fail(function(request, status, error) {
                            $('#loading-spinner').addClass('hidden_icon');
                            bootbox.alert(request.responseText);
                        });
                    }
                }
            });
        };

        $('.btn-unblacklist').click(function() {
            perform_admin_action("Unblacklist", "btn-success", "/results/unblacklist/", $(this));
        });

        $('.btn-blacklist').click(function() {
            perform_admin_action("Blacklist", "btn-danger", "/results/blacklist/", $(this));
        });

    })
</script>
{% endblock %}